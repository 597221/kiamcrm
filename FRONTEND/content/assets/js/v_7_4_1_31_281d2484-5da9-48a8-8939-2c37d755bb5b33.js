import{W as u,R as v,a as p,b as _,j as D,r as B,I as N,U as x}from"./v_7_4_1_31_281d2484-5da9-48a8-8939-2c37d755bb5b10.js";import{b as l,u as W}from"./v_7_4_1_31_281d2484-5da9-48a8-8939-2c37d755bb5b19.js";import{$ as L,B as z,c as O,a3 as U,a4 as R,a5 as j,a6 as P,a7 as F,o as T,Y as y}from"./v_7_4_1_31_281d2484-5da9-48a8-8939-2c37d755bb5b23.js";import{W as k}from"./v_7_4_1_31_281d2484-5da9-48a8-8939-2c37d755bb5b18.js";import{c as $}from"./v_7_4_1_31_281d2484-5da9-48a8-8939-2c37d755bb5b7.js";async function E(e){const{getQuickReply:o}=L.getState(),{sendAction:a}=z.getState();if(e.respostaRapida!==null&&e.respostaRapida.length!==0){const n=o(e.respostaRapida);n?(await a(n,e.userID,{desativar:!1,personalizar:!1,nome:""}),O.getState().dispartWebhook(e.userID.replace(/@c\.us/g,""),"agendamento",{...e})):console.error(`Resposta rapida do ID ${e.respostaRapida} não foi localizada`);return}const s={desativar:!1,personalizar:!1,nome:""};switch(e.tipo){case"txt":R(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break;case"image":F(e.userID,{base64:e.base64,mensagem:e.mensagem,composing:1,aguarde:0,isViewOnce:!1},s);break;case"video":P(e.userID,{base64:e.base64,mensagem:e.mensagem,composing:1,aguarde:0,isViewOnce:!1,microVideo:!1},s);break;case"audio":await j(e.userID,{base64:e.base64,composing:1}),e.mensagem.length>0&&R(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break;case"doc":await U(e.userID,{base64:e.base64,base64Name:e.base64Name}),e.mensagem.length>0&&R(e.userID,{mensagem:e.mensagem,composing:1,aguarde:0},s);break}O.getState().dispartWebhook(e.userID.replace(/@c\.us/g,""),"agendamento",{...e,base64:""})}function V(e,o){const a=new Date(e.data+"T"+e.hora),n=Math.floor((new Date().getTime()-a.getTime())/6e4),d=n<0;if(o){if(!d)return n<=5&&n>=0}else if(!d)return n>=0}const i=$((e,o)=>({agendamentos:[],agendamentosNaoDisparados:[],sendAfterWhatsAppOpens:!1,buttonActive:!1,loadStates:!1,setButtonActive:a=>{o().buttonActive!==a&&(l.getState().plugin_page?u("set-active-button",a,!1):chrome.runtime.sendMessage({action:"set-active-button",dados:a}),e({buttonActive:a}))},setSendAfterWhatsAppOpens:a=>{o().sendAfterWhatsAppOpens===a||a===void 0||a===null||(p("sendAfterWhatsAppOpens",a),l.getState().plugin_page?u("update-send-whats-open",{value:a},!1):chrome.runtime.sendMessage({action:"update-send-whats-open",dados:{value:a}}),e({sendAfterWhatsAppOpens:a}))},addAgendamento:a=>e(s=>{const n=[...s.agendamentos,a];return p("agendamentos",n),l.getState().plugin_page?u("addAgendamento",a,!1):chrome.runtime.sendMessage({action:"addAgendamento",dados:a}),{agendamentos:n}}),iniciarEnvio:async()=>{const{agendamentos:a,loadStates:s}=i.getState();if(!await k.Webpack("isFullReady")||!s)return;const d=new Set,c=a.map(t=>{var h;const g=V(t,o().sendAfterWhatsAppOpens),b=((h=t.recorrencia)==null?void 0:h.length)>0||t.recorrenciaManual;if(g===void 0)return null;const A={...t};return g?A.status="enviado":(A.status=b?"recorrente":"não enviado",A.notsend=!0),A}).filter(Boolean);if(c.length===0)return;const r=c.filter(t=>t.status==="não enviado"||t.status==="enviado"||t.status==="recorrente");if(r.length){let g=o().agendamentosNaoDisparados;g.length>=30?g=[...g.slice(1),...r.slice(-30)]:g=[...g,...r.slice(0,30-g.length)];const b=c.filter(S=>S.status==="recorrente").map(S=>({...S,status:"enviado"}));e({agendamentosNaoDisparados:g}),p("agendamentosNaoDisparados",g);const h=[...o().agendamentos.filter(S=>!r.some(C=>C.id===S.id)),...b];e({agendamentos:h}),p("agendamentos",h)}const m=c.filter(t=>t.status==="enviado"||(t==null?void 0:t.notsend));if(m.length===0)return;const f=[],I=[];for(const t of m)if(!d.has(t.id)&&(d.add(t.id),t!=null&&t.notsend||E(t),I.push(t.id),t.recorrencia&&t.recorrencia.length!==0)){const g=t.recorrenciaManual?x.CalcularProximaDataDias(t.data,t.recorrencia):x.CalcularProximaData(t.data,t.recorrencia);f.push({...t,data:g})}const M=[...a.filter(t=>!I.includes(t.id)),...f],w=m.map(t=>({id:t.id,data:t.data,recorrencia:t.recorrencia}));chrome.runtime.sendMessage({action:"agendamento-dispart",dados:w}),p("agendamentos",M),e({agendamentos:M})},enviarAgendamento:a=>{const s=W.getState().language;_({icon:D.jsx(y,{className:"text-[var(--primaria)]",size:22}),content:D.jsxs(D.Fragment,{children:[s.agenSendSucess,D.jsx("strong",{children:a.titulo}),s.agora,"?"]}),confirmText:s.confirm,submit:()=>{n()}});const n=()=>{E(a),N({type:"Success",message:`${s.oAgendamento} ${a.titulo} ${s.sendSucess}.`,position:"top-right"});const d=o().agendamentosNaoDisparados.map(c=>c.id===a.id?{...c,status:"enviado"}:c);l.getState().plugin_page?u("send-agendamento",d,!1):chrome.runtime.sendMessage({action:"send-agendamento",dados:d}),p("agendamentosNaoDisparados",d),e({agendamentosNaoDisparados:d})}},editAgendamento:(a,s)=>e(n=>{let d,c=n.agendamentosNaoDisparados;s==="agendamento"?(d=n.agendamentos.map(m=>m.id===a.id?{...a}:m),p("agendamentos",d)):s==="relatorio"&&(c=n.agendamentosNaoDisparados.filter(m=>m.id!==a.id),d=[...n.agendamentos,{...a,status:"enviado",id:B()}],p("agendamentosNaoDisparados",c),p("agendamentos",d));const r={editedAgen:a,type:s};return l.getState().plugin_page?u("editAgendamento",r,!0):chrome.runtime.sendMessage({action:"editAgendamento",dados:r}),{agendamentos:d,agendamentosNaoDisparados:c??n.agendamentosNaoDisparados}}),removeAgendamento:(a,s)=>{const n=W.getState().language,d=()=>{if(s==="agendamento"){const r=o().agendamentos.filter(m=>m.id!==a);p("agendamentos",r),e({agendamentos:r}),N({type:"Success",message:n.agendamento_Notif_rm,position:"top-right"})}else if(s==="relatorio"){const r=o().agendamentosNaoDisparados.filter(m=>m.id!==a);p("agendamentosNaoDisparados",r),e({agendamentosNaoDisparados:r}),N({type:"Success",message:n.rel_notify_rm,position:"top-right"})}const c={id:a,type:s};l.getState().plugin_page?u("agendamento-remove",c,!1):chrome.runtime.sendMessage({action:"agendamento-remove",dados:c})};_({icon:D.jsx(y,{className:"text-[var(--primaria)]",size:22}),content:n.agenRemoveConfirm,confirmText:n.confirm,submit:()=>d()})},openUserChat:a=>{a&&(k.Chat("openChatBottom",a),T.getState().close(),l.getState().plugin_page?u("openUserChat",a,!1):chrome.runtime.sendMessage({action:"openUserChat",dados:a}))}})),X=async()=>{l.getState().plugin_page&&u("get-send-whats-open",{},!0);const e=await v("agendamentos")||[],o=await v("agendamentosNaoDisparados")||[],a=await v("sendAfterWhatsAppOpens")||!1;i.setState({agendamentos:e,agendamentosNaoDisparados:o,sendAfterWhatsAppOpens:a,loadStates:!0}),i.getState().iniciarEnvio()};chrome.runtime.onMessage.addListener(async e=>{switch(e.action){case"Update_Agendamento":l.getState().plugin_page||i.getState().iniciarEnvio();break;case"agendamentos-backup-update":X();break;case"agendamento-remove":if(e.dados.type==="agendamento"){const a=i.getState().agendamentos.filter(s=>s.id!==e.dados.id);i.setState({agendamentos:a})}else if(e.dados.type==="relatorio"){const a=i.getState().agendamentosNaoDisparados.filter(s=>s.id!==e.dados.id);i.setState({agendamentosNaoDisparados:a})}break;case"addAgendamento":i.setState({agendamentos:[...i.getState().agendamentos,e.dados]});break;case"editAgendamento":if(e.dados.type==="agendamento"){const a=i.getState().agendamentos.map(s=>s.id===e.dados.editedAgen.id?{...e.dados.editedAgen}:s);i.setState({agendamentos:a})}else if(e.dados.type==="relatorio"){const a=i.getState().agendamentosNaoDisparados.filter(d=>d.id!==e.dados.editedAgen.id),n=[...i.getState().agendamentos,{...e.dados.editedAgen,status:"enviado"}];i.setState({agendamentos:n,agendamentosNaoDisparados:a})}break;case"agendamento-dispart":let o=i.getState().agendamentos;e.dados.map(a=>{a.recorrencia.length==0?o=o.filter(s=>s.id!==a.id):o=o.map(s=>(s.id===a.id&&(s.data=a.data,s.recorrencia=a.recorrencia),s))}),i.setState({agendamentos:o});break;case"update-send-whats-open":e.dados.value!==void 0&&i.getState().setSendAfterWhatsAppOpens(e.dados.value);break;case"get-send-whats-open":chrome.runtime.sendMessage({action:"update-send-whats-open",dados:{value:i.getState().sendAfterWhatsAppOpens}});break;case"set-active-button":i.getState().setButtonActive(e.dados);break;case"send-agendamento":i.setState({agendamentosNaoDisparados:e.dados});break;case"openUserChat":k.Chat("openChatBottom",e.dados),T.getState().close();break}});const Q=async(e,o,a)=>{i.setState({agendamentos:e,agendamentosNaoDisparados:o,sendAfterWhatsAppOpens:a}),await p("agendamentos",e),await p("agendamentosNaoDisparados",o),chrome.runtime.sendMessage({action:"agendamentos-backup-update"})},q=(e,o,a)=>{const{agendamentos:s,agendamentosNaoDisparados:n}=i.getState(),d=[...s],c=[...n];e.forEach(r=>{const m=d.findIndex(f=>f.id===r.id);m===-1?d.push(r):d[m]=r}),o.forEach(r=>{const m=c.findIndex(f=>f.id===r.id);m===-1?c.push(r):c[m]=r}),Q(d,c,a)};export{q as M,Q as R,X as i,i as u};
